<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Understand the Entrypoint and the Proof - TzSafe User Manual</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../marigold-docs-theme/marigold.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guides/create-new-wallets.html"><strong aria-hidden="true">1.1.</strong> Create new wallets</a></li><li class="chapter-item expanded "><a href="../guides/import-wallets.html"><strong aria-hidden="true">1.2.</strong> Import wallets</a></li><li class="chapter-item expanded "><a href="../guides/fund-wallet.html"><strong aria-hidden="true">1.3.</strong> Fund wallet</a></li><li class="chapter-item expanded "><a href="../guides/create-proposals.html"><strong aria-hidden="true">1.4.</strong> Create Proposals</a></li><li class="chapter-item expanded "><a href="../guides/sign-reject-and-resolve-proposals.html"><strong aria-hidden="true">1.5.</strong> Sign, Reject and Resolve Proposals</a></li><li class="chapter-item expanded "><a href="../guides/setting.html"><strong aria-hidden="true">1.6.</strong> Setting</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Developer DOC</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guides/understand-entrypoint-and-proof-of-tzsafe.html" class="active"><strong aria-hidden="true">2.1.</strong> Understand the Entrypoint and the Proof</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">TzSafe User Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/marigold-dev/tzsafe" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="understand-the-entrypoint-and-the-proof"><a class="header" href="#understand-the-entrypoint-and-the-proof">Understand the Entrypoint and the Proof</a></h1>
<p>TzSafe, a multisig wallet, is created using a smart contract. The TzSafe application, <a href="https://tzsafe.marigold.dev">TzSafe UI</a>, offers a user-friendly interface for interacting with wallets. If users wish to develop their own smart contract to interact with TzSafe, understanding the entrypoints of the wallets is crucial. This section will introduce the entrypoints of TzSafe in different versions. We'll use Better-Call Dev as an example to demonstrate.</p>
<p>To determine the version of TzSafes:</p>
<ul>
<li>Within the TzSafe application, you can find the version information as follows:</li>
</ul>
<p><img src="../assets/image-70.png" alt="" /></p>
<h2 id="version-03x"><a class="header" href="#version-03x">Version â‰¥0.3.x</a></h2>
<ul>
<li>Beginning with version 0.3.0, wallets can generate proof.</li>
<li>Beginning with version 0.3.0, wallets will free up storage space upon the resolution of proposals, leading to savings on storage fees for subsequent proposal creations. Please be aware of security issue: the newly added entrypoint for updating metadata does not check ownership, which means that anyone can modify the wallet's metadata.</li>
<li>Beginning with version 0.3.2, wallets now support two new types of proposals: <code>add_or_update_metadata</code> and <code>remove_metadata</code>. Please note that this support is available only in the contract, not in the TzSafe UI.</li>
</ul>
<h3 id="version-032"><a class="header" href="#version-032">Version 0.3.2</a></h3>
<p>To align with TZIP-27, TzSafe team offers several proposed models for integration. For more detailed information, please refer to <a href="https://forum.tezosagora.org/t/tzsafe-and-proof-of-event-with-demos/5672">this link</a>. We have chosen to implement the &quot;PoE as an executed action&quot; model, and we will maintain the usage of the term &quot;actions&quot; as a way to distinguish them from Tezos' standard transactions.</p>
<p>ðŸ’¡ Transactions approved through the owners' consensus are referred to as &quot;actions&quot; to differentiate the term from Tezos' standard transactions.</p>
<p>Regarding the interface adaptation, it may seem complex and daunting for users when dealing with the entrypoints and parameters required for signing and resolving proposals. On the contrary, the process is straightforward. Users do not need to calculate signatures or hash data themselves. From proposal creation to resolution, all that's needed is a blocker explorer to check the results of the operations.</p>
<h3 id="create-a-proposal"><a class="header" href="#create-a-proposal">Create a Proposal</a></h3>
<p>The <strong><code>create_proposal</code></strong> entrypoint is employed to generate proposals, taking a list of proposal contents as its parameter. </p>
<p><img src="../assets/image-71.png" alt="" /></p>
<p>By clicking <code>+ADD</code>, we can select the kind of proposal to create.</p>
<p><img src="../assets/image-72.png" alt="" /></p>
<p>When designing the TzSafe contract, appropriate annotations are assigned to each variable within the parameters. Consequently, when inspecting the TzSafe contract on Better-Call Dev, interaction is straightforward, as each field is largely self-explanatory.</p>
<p><img src="../assets/image-73.png" alt="" /></p>
<p>Upon the successful creation of a proposal by an owner, an event tagged <strong><code>%create_proposal</code></strong> is emitted.</p>
<p><img src="../assets/image-74.png" alt="" /></p>
<p><img src="../assets/image-75.png" alt="" /></p>
<p>This event includes two pieces of information that we'll need them to sign and resolve the proposal:</p>
<ul>
<li><strong><code>challenge_id</code></strong>: This represents a unique ID for each proposal, presented in bytes. With each new proposal, the ID increases by one.</li>
<li><strong><code>payload</code></strong>: This contains the proposal's content but is encoded in Michelson's <strong><code>pack</code></strong>. If we  <strong><code>unpack</code></strong> the payload, it should match the input parameter. However, typically, there's no need to <strong><code>unpack</code></strong>. If the need does arise, we must specify the type, which can be found either:
<ul>
<li><a href="https://github.com/marigold-dev/tzsafe-ui/blob/v0.38.0/types/Proposal0_3_1.ts#L164">here</a> in JSON format.</li>
<li><a href="https://github.com/marigold-dev/tzsafe/blob/0.3.2/src/internal/proposal_content.mligo#L19">here</a> in the camligo. Please note that you need to include this type in the list, as illustrated in the example below.</li>
</ul>
</li>
</ul>
<p>Here's an example of using <strong><code>unpack</code></strong> in the camligo:</p>
<pre><code>&gt;  git clone git@github.com:marigold-dev/tzsafe.git
&gt;  cd tzsafe
&gt;  cat unpack_proposal_contents.mligo

#import &quot;./tzsafe/src/internal/proposal_content.mligo&quot; &quot;Proposal_content&quot;

type proposal_content = Proposal_content.Types.t
type proposal_contents = proposal_content list

&gt; cat unpack_proposal_contents.mligo
let test_unpack_proposal_contents =
  // remember to add prefix &quot;0x&quot; to the bytes receiving from the event with tag `%create_proposal`
  let bytes = 0x0502000000250508050807070a0000001601361c589d324f1575cccb0adcb58664174c74ee7c000080897a in
  // print unpack result
  Test.log (Bytes.unpack bytes : proposal_contents option)

&gt;  ligo run test unpack_proposal_contents.mligo
Some ([Transfer ({amount = 1000000mutez ; target = KT1DWt1ec76EPrvavMS4Rz95hkYGJFLP3iTp})])
Everything at the top-level was executed.
- test_unpack_proposal_content exited with value ().
</code></pre>
<h3 id="sign-a-proposal"><a class="header" href="#sign-a-proposal">Sign a Proposal</a></h3>
<p>The <strong><code>sign_proposal</code></strong> entrypoint is used to sign a proposal. To sign a proposal, it must first be created. Therefore, we can only provide the <strong><code>challenge_id</code></strong> and <strong><code>payload</code></strong> obtained during the proposal creation. If we agree to execute the proposal, the <strong><code>agreement</code></strong> field should be set to <strong><code>true</code></strong> (check the checkbox); otherwise, it should be set to <strong><code>false</code></strong>(uncheck the checkbox).</p>
<p><img src="../assets/image-76.png" alt="" /></p>
<p>TzSafe requires <strong><code>payload</code></strong> to be provided again in <strong><code>sign_proposal</code></strong> to prevent reorgs. By verifying both the <strong><code>challenge_id</code></strong> and <strong><code>payload</code></strong>, TzSafe ensures that we are executing the intended content.</p>
<p>Once the signing is completed, an event is emitted with the tag <strong><code>%sign_proposal</code></strong>. This event is simply for displaying the signing result.</p>
<p><img src="../assets/image-77.png" alt="" /></p>
<h3 id="resolve-a-proposal-and-generate-the-proof"><a class="header" href="#resolve-a-proposal-and-generate-the-proof">Resolve a Proposal and Generate the Proof</a></h3>
<p>The entrypoint for resolving is named <strong><code>challenge_proof_of_event</code></strong> in accordance with TZIP-27. However, it can only be successfully performed when certain conditions are met. Please see <a href="./sign-reject-and-resolve-proposals.html">here</a> for more details.</p>
<p>Similar to signing a proposal, we need to provide the <strong><code>challenge_id</code></strong> and <strong><code>payload</code></strong> obtained during proposal creation to ensure that reorgs have occurred.</p>
<p><img src="../assets/image-78.png" alt="" /></p>
<p>When this entrypoint is successfully executed, two events are emitted:</p>
<ol>
<li>An event with the tag <strong><code>%resolve_proposal</code></strong> shows the simple result of the proposal, including whether it was <code>executed</code>, <code>rejected</code>, or <code>expired</code>. In most cases, this information is sufficient.</li>
<li>The other event, tagged as <strong><code>%proof_of_event</code></strong>, serves as <em>the proof of event</em> for TZIP-27. This proof contains a pair of <strong><code>challenge_id</code></strong> and <strong><code>payload</code></strong>. The payload is encoded in Michelson's <strong><code>pack</code></strong> . If we perform <strong><code>unpack</code></strong>, we can access the details of the proposal, including signers, resolvers, contents, and more. The type for <strong><code>unpack</code></strong> can be found:
<ul>
<li><a href="https://github.com/marigold-dev/tzsafe-ui/blob/v0.38.0/types/Proposal0_3_1.ts#L42">here</a> in JSON format.</li>
<li><a href="https://github.com/marigold-dev/tzsafe/blob/0.3.2/src/internal/storage.mligo#L38">here</a> in the camligo.</li>
</ul>
</li>
</ol>
<p><img src="../assets/image-79.png" alt="" /></p>
<p>Here is an example of using <strong><code>unpack</code></strong> in the camligo:</p>
<pre><code>&gt;  git clone git@github.com:marigold-dev/tzsafe.git
&gt;  cd tzsafe
&gt;  cat unpack_proposal.mligo
#import &quot;./tzsafe/src/internal/storage.mligo&quot; &quot;Storage&quot;

type proposal = Storage.Types.proposal

let test_unpack_proposal =
  // remember to add prefix &quot;0x&quot; to the bytes receiving from the proof
  let bytes = 0x05070705050505030b0707020000001f07040a00000016000101e9a6d43af927384fcd1068ffc12e461e219f20030a070707070a00000016000101e9a6d43af927384fcd1068ffc12e461e219f2000bfe9bbd30c0707050907070a00000016000101e9a6d43af927384fcd1068ffc12e461e219f2000a7edbbd30c02000000230508050807070a000000160142d3fb211660bcec97e8117919c549337a2cb425000001 in

  // print unpack result
  Test.log (Bytes.unpack bytes : proposal option)

&gt;  ligo run test unpack_proposal.mligo
Some ({contents = [Transfer ({amount = 1mutez ; target = KT1Eg8784FTRicrRW9nt13fvRh1hYKWwFF9X})] ; proposer = {actor = tz28VMEvxy1pwb7prrvGwLw4bQf2eCMn6P1c ; timestamp = timestamp(2023-10-24T08:04:15Z)} ; resolver = Some ({actor = tz28VMEvxy1pwb7prrvGwLw4bQf2eCMn6P1c ; timestamp = timestamp(2023-10-24T08:08:07Z)}) ; signatures = [tz28VMEvxy1pwb7prrvGwLw4bQf2eCMn6P1c -&gt; true] ; state = Executed (())})
Everything at the top-level was executed.
- test_unpack exited with value ().

</code></pre>
<p>Both users and DApps can track the new actions of TzSafe without being inconvenienced by internal TzSafe operations by monitoring the events <strong><code>%proof_of_event</code></strong> or <strong><code>%resolve_proposal</code></strong> tags. We can utilize APIs provided by TZKT or Taquito to assist us in this regard. Please note that if the proof is intended for any purpose, it is crucial to verify the proof as the initial step. In the TzSafe design, each operation containing the proposal resolution will also have only one associated proof.</p>
<h3 id="version-031"><a class="header" href="#version-031">Version 0.3.1</a></h3>
<p>Please pay attention to a security concern: the newly introduced entrypoint for updating metadata in the contract storage, following TZIP-16, does not verify ownership, enabling anyone to modify the wallet's metadata. It's important to note that this issue does not affect the other TzSafe functions, nor the TzSafe UI. Individuals concerned about this issue should consider migrating to at least version 0.3.2.</p>
<p>The following are the types needed if one wants to access the details of the bytes produced by the wallet.</p>
<ul>
<li>
<p>the type of proposals:</p>
<ul>
<li>in <a href="https://github.com/marigold-dev/tzsafe-ui/blob/v0.37.0/types/Proposal0_3_1.ts#L164">JSON</a> format.</li>
<li>in the <a href="https://github.com/marigold-dev/tzsafe/blob/0.3.1/src/internal/proposal_content.mligo#L19">camligo</a>. Please note that you need to include this type in the list.</li>
</ul>
</li>
<li>
<p>the type of proof:</p>
<ul>
<li>in <a href="https://github.com/marigold-dev/tzsafe-ui/blob/v0.37.0/types/Proposal0_3_1.ts#L42">JSON</a> format.</li>
<li>in the <a href="https://github.com/marigold-dev/tzsafe/blob/0.3.1/src/internal/storage.mligo#L38">camligo</a>.</li>
</ul>
</li>
</ul>
<h3 id="version-030"><a class="header" href="#version-030">Version 0.3.0</a></h3>
<p>Version 0.3.0 supports generating proof but does not support saving storage fees. This version is exclusively available on the ghostnet.</p>
<h2 id="version--01"><a class="header" href="#version--01">Version â‰¤ 0.1</a></h2>
<p>In contrast to version â‰¥ 0.3.1, the entrypoints and their parameters are self-explanatory and presented in readable types, ensuring a user-friendly interaction with them on Better-Call Dev for developing.</p>
<p>Events are still emitted when proposals are created, signed, and resolved. It's important to note that there is no proof emitted to conform to the TZIP-27 standard.</p>
<p>Please note that there is a legacy proposal content, <code>execute</code> of <code>create_proposal</code>, in the contract. The legacy proposal content functions the same as <code>transfer</code>. The <code>execute</code> was designed to be able to customizabled the type when users generate contracts, allowing the wallet to call other specific contracts. In some cases, if the wallet consistently interacts with a specific contract, this can save on storage and gas fees. Now, we are inclined to use <code>execute_lambda</code> to replace <code>execute</code>, so the <code>execute</code> version has been removed in version â‰¥ 0.3.1.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../guides/setting.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../guides/setting.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../marigold-docs-theme/marigold.js"></script>


    </div>
    </body>
</html>
